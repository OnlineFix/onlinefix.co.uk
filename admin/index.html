<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Admin Dashboard - OnlineFix Repair Management</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"
        integrity="sha512-fD9DI5bZwQxOi7MhYWnnNPlvXdp/2Pj3XSTRrFs5FQa4mizyGLnJcN6tuvUS6LbmgN1ut+XGSABKvjN0H6Aoow=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Premium Dark Mode Colors */
            --bg-base: #0B0E14;
            /* Deepest dark for background */
            --bg-surface: #151A23;
            /* Slightly lighter for cards/sections */
            --bg-elevated: #1F2735;
            /* Pop-outs, modals, hover states */

            --primary-blue: #0033FF;
            /* Brand color */
            --primary-glow: rgba(0, 51, 255, 0.4);
            --accent-cyan: #00E4FF;
            /* Secondary accent */

            --text-main: #FFFFFF;
            --text-muted: #94A3B8;
            --text-dark: #64748B;

            --border-color: rgba(255, 255, 255, 0.08);

            /* Status Colors */
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 20px var(--primary-glow);

            /* Utilities */
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--text-main);
            background: var(--bg-base);
            min-height: 100vh;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-surface);
            border-right: 1px solid var(--border-color);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-main);
            margin-bottom: 0.5rem;
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .user-info {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .sidebar-nav {
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1rem;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: var(--radius-md);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            background: var(--bg-elevated);
            color: var(--primary-cyan);
            box-shadow: inset 3px 0 0 var(--primary-blue);
        }

        .nav-link.active {
            color: var(--text-main);
            background: linear-gradient(90deg, rgba(0, 51, 255, 0.15) 0%, transparent 100%);
            box-shadow: inset 3px 0 0 var(--primary-blue);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
            color: inherit;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        /* Header */
        .header {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
            box-shadow: 0 4px 15px var(--primary-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--primary-glow);
            filter: brightness(1.1);
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .btn-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1rem;
            color: var(--white);
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            margin-bottom: 0.2rem;
            background: linear-gradient(135deg, #fff, #aaa);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.95rem;
        }

        /* Content Sections */
        .content-section {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .section-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .section-content {
            padding: 2rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            text-align: left;
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        tr {
            transition: background-color 0.2s ease;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-received {
            background: rgba(59, 130, 246, 0.15);
            color: #60A5FA;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-diagnosing {
            background: rgba(245, 158, 11, 0.15);
            color: #FBBF24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .status-waiting-parts {
            background: rgba(239, 68, 68, 0.15);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-in-repair {
            background: rgba(139, 92, 246, 0.15);
            color: #A78BFA;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .status-testing {
            background: rgba(14, 165, 233, 0.15);
            color: #38BDF8;
            border: 1px solid rgba(14, 165, 233, 0.3);
        }

        .status-ready {
            background: rgba(16, 185, 129, 0.15);
            color: #34D399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-completed {
            background: rgba(100, 116, 139, 0.15);
            color: #94A3B8;
            border: 1px solid rgba(100, 116, 139, 0.3);
        }

        /* Delete button */
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        /* Photo upload in modal */
        .photo-upload-small {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
            background: var(--bg-base);
        }

        .photo-upload-small:hover {
            border-color: var(--primary-blue);
            background: rgba(0, 51, 255, 0.05);
            box-shadow: inset 0 0 10px rgba(0, 51, 255, 0.1);
        }

        .photo-preview-small {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .photo-item-small {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .photo-item-small img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .photo-remove-small {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(239, 68, 68, 0.9);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.7rem;
            backdrop-filter: blur(4px);
        }

        /* Template selector */
        .template-selector {
            margin-bottom: 1rem;
        }

        .template-btn {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-muted);
        }

        .template-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-main);
            border-color: var(--primary-cyan);
            box-shadow: inset 0 0 5px rgba(0, 228, 255, 0.2);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            padding: 0.85rem;
            border: 1px solid var(--border-color);
            background: var(--bg-base);
            color: var(--text-main);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 51, 255, 0.2);
        }

        .form-input::placeholder {
            color: var(--text-dark);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394A3B8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path মুক্তির%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.2rem;
            padding-right: 2.5rem;
        }

        .form-select option {
            background-color: var(--bg-surface);
            color: var(--text-main);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background: var(--bg-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-md), 0 0 40px rgba(0, 0, 0, 0.5);
            animation: modalSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            transform: rotate(90deg);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 51, 255, 0.2);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Success/Error messages */
        .alert {
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            font-weight: 500;
            animation: alertSlideIn 0.3s ease;
        }

        @keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: #34D399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            color: #F87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Hamburger menu toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.4rem;
            color: var(--text-main);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .menu-toggle:hover {
            background: var(--bg-elevated);
        }

        /* Sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .main-content {
                padding: 0.75rem;
            }

            .header {
                padding: 0.75rem 1rem;
                flex-direction: row;
                gap: 0.5rem;
            }

            .header-title {
                font-size: 1.2rem;
            }

            .header-actions .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }

            .header-actions .btn-label {
                display: none;
            }

            /* Stats - 2 columns on mobile */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.75rem;
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.8rem;
            }

            /* Section headers */
            .section-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
                align-items: flex-start;
            }

            .section-header > div {
                width: 100%;
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .section-header .form-input,
            .section-header select {
                width: 100% !important;
                margin-right: 0 !important;
            }

            .section-content {
                padding: 0.75rem;
            }

            /* Tables - card layout on mobile */
            .table-container table thead {
                display: none;
            }

            .table-container table,
            .table-container table tbody,
            .table-container table tr,
            .table-container table td {
                display: block;
                width: 100%;
            }

            .table-container table tr {
                background: var(--bg-elevated);
                border: 1px solid var(--border-color);
                border-radius: var(--radius-md);
                padding: 1rem;
                margin-bottom: 0.75rem;
            }

            .table-container table td {
                padding: 0.25rem 0;
                border-bottom: none;
                text-align: left;
            }

            .table-container table td:before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 0.75rem;
                color: var(--text-muted);
                text-transform: uppercase;
                display: block;
                margin-bottom: 0.15rem;
            }

            .table-container table td:last-child {
                padding-top: 0.75rem;
                margin-top: 0.5rem;
                border-top: 1px solid var(--border-color);
                display: flex;
                gap: 0.5rem;
            }

            .table-container table td:last-child .btn {
                flex: 1;
                justify-content: center;
            }

            /* Forms */
            .form-grid {
                grid-template-columns: 1fr;
            }

            /* Modals - slide up from bottom on mobile */
            .modal.show {
                align-items: flex-end;
            }

            .modal-content {
                width: 100% !important;
                max-width: 100% !important;
                max-height: 95vh;
                border-radius: var(--radius-lg) var(--radius-lg) 0 0;
                padding: 1.5rem;
            }

            .modal-title {
                font-size: 1.2rem;
            }

            .modal-content .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Very small screens */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .main-content {
                padding: 0.5rem;
            }
        }

        /* Communication action buttons */
        .comms-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .comms-btn {
            flex: 1;
            min-width: 120px;
            justify-content: center;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .comms-whatsapp {
            background: #25D366;
            color: #fff;
            border: none;
        }

        .comms-whatsapp:hover {
            background: #1ebe57;
            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .comms-sms {
            background: var(--info);
            color: #fff;
            border: none;
        }

        .comms-sms:hover {
            background: #2563eb;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .comms-copy {
            background: var(--bg-elevated);
            color: var(--text-main);
            border: 1px solid var(--border-color);
        }

        .comms-copy:hover {
            background: var(--bg-surface);
            border-color: var(--accent-cyan);
        }

        /* Helper Classes */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div
            style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle at center, var(--bg-surface), var(--bg-base)); position: relative; overflow: hidden;">
            <!-- Subtle background elements -->
            <div
                style="position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%); top: -300px; left: -300px; opacity: 0.5; pointer-events: none;">
            </div>
            <div
                style="position: absolute; width: 400px; height: 400px; background: radial-gradient(circle, rgba(0,228,255,0.15) 0%, transparent 70%); bottom: -200px; right: -200px; opacity: 0.6; pointer-events: none;">
            </div>

            <div
                style="background: rgba(21, 26, 35, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 3rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md), inset 0 0 0 1px var(--border-color); max-width: 400px; width: 90%; z-index: 1;">
                <div style="text-align: center; margin-bottom: 2.5rem;">
                    <div class="logo" style="font-size: 2.5rem; margin-bottom: 0.5rem; letter-spacing: -1px;">OnlineFix
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.95rem;">Admin Dashboard Secure Auth</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">Admin Email</label>
                        <input type="email" class="form-input" id="login-email" placeholder="admin@onlinefix.co.uk"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="login-password" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="btn btn-primary"
                        style="width: 100%; justify-content: center; margin-top: 1rem; padding: 1rem;">
                        <i class="fas fa-lock"></i>
                        Authenticate
                    </button>
                </form>
                <div id="login-error" class="alert alert-error hidden"
                    style="margin-top: 1.5rem; text-align: center; font-size: 0.9rem;"></div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="admin-layout hidden">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">OnlineFix</div>
                <div class="user-info" id="user-email">Admin Dashboard</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="overview">
                        <i class="fas fa-chart-line"></i>
                        Overview
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="repairs">
                        <i class="fas fa-tools"></i>
                        All Repairs
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" id="logout-link">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" id="page-title">Dashboard Overview</h1>
                </div>
                <div class="header-actions">
                    <a href="../new-repair/" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        <span class="btn-label">New Repair</span>
                    </a>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overview-section" class="content-section">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--primary-blue);">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="stat-number" id="total-repairs">0</div>
                        <div class="stat-label">Total Repairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="active-repairs">0</div>
                        <div class="stat-label">Active Repairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--success);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-number" id="ready-repairs">0</div>
                        <div class="stat-label">Ready for Collection</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--trust-teal);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="total-customers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                </div>

                <!-- Recent Repairs -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Repairs</h2>
                        <button class="btn btn-secondary" id="view-all-repairs-btn">View All</button>
                    </div>
                    <div class="section-content">
                        <div class="table-container">
                            <table id="recent-repairs-table">
                                <thead>
                                    <tr>
                                        <th>Repair ID</th>
                                        <th>Customer</th>
                                        <th>Device</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Repairs Section -->
            <div id="repairs-section" class="content-section hidden">
                <div class="section-header">
                    <h2 class="section-title">All Repairs</h2>
                    <div>
                        <select id="common-repair-filter" class="form-input"
                            style="display: inline-block; width: auto; margin-right: 1rem;">
                            <option value="">All Services</option>
                            <option value="hdmi">Console HDMI Port Replacement</option>
                            <option value="cleaning">Console Cleaning</option>
                            <option value="pc-rebuild">PC Rebuild</option>
                            <option value="laptop-diag">Laptop Diagnostics</option>
                        </select>
                        <select id="status-filter" class="form-input"
                            style="display: inline-block; width: auto; margin-right: 1rem;">
                            <option value="">All Statuses</option>
                            <option value="received">Received</option>
                            <option value="diagnosing">Diagnosing</option>
                            <option value="waiting-parts">Waiting for Parts</option>
                            <option value="in-repair">In Repair</option>
                            <option value="testing">Testing</option>
                            <option value="ready">Ready</option>
                            <option value="completed">Completed</option>
                        </select>
                        <a href="../new-repair/" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            New Repair
                        </a>
                    </div>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table id="all-repairs-table">
                            <thead>
                                <tr>
                                    <th>Repair ID</th>
                                    <th>Customer</th>
                                    <th>Device</th>
                                    <th>Issue</th>
                                    <th>Status</th>
                                    <th>Date Received</th>
                                    <th>Est. Completion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading dashboard data...</p>
            </div>
        </main>
    </div>

    <script>
        // Mobile sidebar toggle
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
            document.getElementById('sidebar-overlay').classList.toggle('show');
        }

        // Utility for escaping HTML to prevent XSS
        function escapeHTML(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKBlO4aHTVSjwyevg1OYZ0NWy3Y62HJuU",
            authDomain: "onlinefix-repair.firebaseapp.com",
            projectId: "onlinefix-repair",
            storageBucket: "onlinefix-repair.firebasestorage.app",
            messagingSenderId: "382934797751",
            appId: "1:382934797751:web:5ac8a9c87d68a17b4cec32"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let allRepairs = [];
        let updatePhotos = [];

        // Status configuration
        const statusConfig = {
            'received': { label: 'Received', class: 'status-received' },
            'diagnosing': { label: 'Diagnosing', class: 'status-diagnosing' },
            'waiting-parts': { label: 'Waiting for Parts', class: 'status-waiting-parts' },
            'in-repair': { label: 'In Repair', class: 'status-in-repair' },
            'testing': { label: 'Testing', class: 'status-testing' },
            'ready': { label: 'Ready for Collection', class: 'status-ready' },
            'completed': { label: 'Completed', class: 'status-completed' }
        };

        // Status update templates
        const statusTemplates = {
            'diagnosing': [
                'Initial diagnosis in progress. We are examining your device to identify all issues.',
                'Running diagnostic tests to determine the exact cause of the problem.',
                'Device diagnosis complete. We have identified the issues and will proceed with repairs.'
            ],
            'waiting-parts': [
                'We need to order replacement parts for your device. Expected arrival within 2-3 business days.',
                'Waiting for specific components to arrive. We\'ll update you once parts are received.',
                'Additional parts required for complete repair. Order has been placed with our supplier.'
            ],
            'in-repair': [
                'Repair work has begun on your device. Our technician is working on fixing the identified issues.',
                'Your device is currently being repaired. We expect to complete the work within 24-48 hours.',
                'Repair in progress. Additional issues were discovered that require attention.'
            ],
            'testing': [
                'Repair completed. Now conducting thorough testing to ensure everything works perfectly.',
                'Running quality checks and stress tests on your repaired device.',
                'Final testing phase. Verifying all functions are working as expected.'
            ],
            'ready': [
                'Great news! Your device is repaired and ready for collection. Please bring your receipt.',
                'Repair completed successfully. Your device is ready to be picked up at your convenience.',
                'Your device has been fully repaired and tested. Ready for collection during business hours.'
            ],
            'completed': [
                'Repair completed and device collected. Thank you for choosing OnlineFix!',
                'Service completed. We hope you\'re satisfied with our repair service.',
                'Device successfully repaired and delivered to customer.'
            ]
        };

        // Customer message templates (for WhatsApp/SMS)
        const customerMessages = {
            'received': (name, device, repairId) =>
                `Hi ${name}, thanks for dropping off your ${device} at OnlineFix. Your repair ID is ${repairId}. We'll keep you updated as we work on it. You can track progress here: https://onlinefix.co.uk/track/?id=${repairId}`,
            'diagnosing': (name, device, repairId) =>
                `Hi ${name}, we've started diagnosing your ${device}. We'll be in touch once we've identified the issue and can give you a quote. Track progress: https://onlinefix.co.uk/track/?id=${repairId}`,
            'waiting-parts': (name, device, repairId) =>
                `Hi ${name}, we've diagnosed your ${device} and need to order a part. Expected arrival is 2-3 business days. We'll let you know as soon as it arrives. Track progress: https://onlinefix.co.uk/track/?id=${repairId}`,
            'in-repair': (name, device, repairId) =>
                `Hi ${name}, your ${device} is now being repaired. We'll update you once it's done and tested. Track progress: https://onlinefix.co.uk/track/?id=${repairId}`,
            'testing': (name, device, repairId) =>
                `Hi ${name}, the repair on your ${device} is complete and we're running final tests to make sure everything works perfectly. Nearly there! Track progress: https://onlinefix.co.uk/track/?id=${repairId}`,
            'ready': (name, device, repairId) =>
                `Hi ${name}, great news! Your ${device} is repaired, tested, and ready for collection. Please bring your receipt when you pick up. Give us a call if you need to arrange a time. Track progress: https://onlinefix.co.uk/track/?id=${repairId}`,
            'completed': (name, device, repairId) =>
                `Hi ${name}, thanks for choosing OnlineFix for your ${device} repair. Your 90-day warranty is now active. If you have any issues, don't hesitate to get in touch. Cheers, Tomas`
        };

        // Generate customer message for a repair
        function getCustomerMessage(repair) {
            const name = repair.customerName.split(' ')[0]; // first name only
            const device = `${repair.brand} ${repair.model}`.trim();
            const template = customerMessages[repair.currentStatus];
            return template ? template(name, device, repair.repairId) : `Hi ${name}, here's an update on your ${device} repair (${repair.repairId}). Track progress: https://onlinefix.co.uk/track/?id=${repair.repairId}`;
        }

        // Send via WhatsApp
        function sendWhatsApp(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;
            const phone = repair.customerPhone.replace(/\D/g, '').replace(/^0/, '44');
            const message = encodeURIComponent(getCustomerMessage(repair));
            window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
        }

        // Send via SMS
        function sendSMS(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;
            const message = encodeURIComponent(getCustomerMessage(repair));
            window.open(`sms:${repair.customerPhone}?body=${message}`, '_self');
        }

        // Copy tracking link
        function copyTrackingLink(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;
            const link = `https://onlinefix.co.uk/track/?id=${repair.repairId}`;
            navigator.clipboard.writeText(link).then(() => {
                showAlert('Tracking link copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const input = document.createElement('input');
                input.value = link;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                showAlert('Tracking link copied!', 'success');
            });
        }

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                showDashboard();
                loadDashboardData();
            } else {
                showLogin();
            }
        });

        // Login form submission
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showLoginError(error.message);
            }
        });

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.closest('.nav-link').dataset.section;
                if (section) {
                    showSection(section);
                }
                // Close sidebar on mobile after navigation
                document.getElementById('sidebar').classList.remove('show');
                document.getElementById('sidebar-overlay').classList.remove('show');
            });
        });

        // Status filter
        document.getElementById('status-filter').addEventListener('change', () => {
            loadAllRepairs();
        });

        // Common repair filter
        document.getElementById('common-repair-filter').addEventListener('change', () => {
            loadAllRepairs();
        });

        // Show/hide screens
        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Logout
        function logout() {
            auth.signOut();
        }

        // Navigation
        function showSection(sectionName) {
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionName) {
                    link.classList.add('active');
                }
            });

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            const section = document.getElementById(`${sectionName}-section`);
            if (section) {
                section.classList.remove('hidden');
            }

            // Update page title
            const titles = {
                'overview': 'Dashboard Overview',
                'repairs': 'All Repairs'
            };
            document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';

            // Load section-specific data
            if (sectionName === 'repairs') {
                loadAllRepairs();
            } else if (sectionName === 'overview') {
                updateStats();
                loadRecentRepairs();
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            document.getElementById('loading').style.display = 'block';

            try {
                // Load repairs
                const repairsSnapshot = await db.collection('repairs').get();
                allRepairs = repairsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update stats
                updateStats();

                // Load recent repairs
                loadRecentRepairs();

                // Keep 'All Repairs' table in sync
                loadAllRepairs();

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showAlert('Error loading data: ' + error.message, 'error');
            }
        }

        // Update stats
        function updateStats() {
            const activeRepairs = allRepairs.filter(r =>
                !['completed'].includes(r.currentStatus)
            ).length;

            const readyRepairs = allRepairs.filter(r =>
                r.currentStatus === 'ready'
            ).length;

            const customers = new Set(allRepairs.map(r => r.customerEmail || r.customerPhone)).size;

            document.getElementById('total-repairs').textContent = allRepairs.length;
            document.getElementById('active-repairs').textContent = activeRepairs;
            document.getElementById('ready-repairs').textContent = readyRepairs;
            document.getElementById('total-customers').textContent = customers;
        }

        // Load recent repairs
        function loadRecentRepairs() {
            const recent = allRepairs
                .sort((a, b) => {
                    const aTime = a.dateReceived?.seconds || 0;
                    const bTime = b.dateReceived?.seconds || 0;
                    return bTime - aTime;
                })
                .slice(0, 10);

            const tbody = document.querySelector('#recent-repairs-table tbody');
            tbody.innerHTML = '';

            recent.forEach(repair => {
                const row = createRepairRow(repair);
                tbody.appendChild(row);
            });
        }

        // Create repair table row
        function createRepairRow(repair) {
            const row = document.createElement('tr');
            const status = statusConfig[repair.currentStatus] || statusConfig['received'];
            const date = repair.dateReceived ? new Date(repair.dateReceived.seconds * 1000).toLocaleDateString('en-GB') : 'N/A';

            row.innerHTML = `
                <td data-label="Repair ID"><strong>${escapeHTML(repair.repairId)}</strong></td>
                <td data-label="Customer">${escapeHTML(repair.customerName)}</td>
                <td data-label="Device">${escapeHTML(repair.brand)} ${escapeHTML(repair.model)}</td>
                <td data-label="Status"><span class="status-badge ${status.class}">${status.label}</span></td>
                <td data-label="Date">${date}</td>
                <td data-label="">
                    <button class="btn btn-secondary" style="padding: 0.5rem;" data-action="view" data-id="${repair.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-primary" style="padding: 0.5rem;" data-action="edit" data-id="${repair.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem;" data-action="delete" data-id="${repair.id}" data-repair-id="${repair.repairId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // View repair details
        function viewRepair(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Repair Details - ${escapeHTML(repair.repairId)}</h2>
                        <button class="close-btn" data-action="close-modal">&times;</button>
                    </div>
                    <div style="max-height: 70vh; overflow-y: auto; padding-right: 1rem;">
                        <div class="form-grid" style="margin-bottom: 2rem;">
                            <div style="background: var(--bg-surface); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--radius-lg);">
                                <h3 style="color: var(--text-main); margin-bottom: 1rem;">Customer Information</h3>
                                <p><strong>Name:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.customerName)}</span></p>
                                <p><strong>Phone:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.customerPhone)}</span></p>
                                ${repair.customerEmail ? `<p><strong>Email:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.customerEmail)}</span></p>` : ''}
                                ${repair.customerAddress ? `<p><strong>Address:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.customerAddress)}</span></p>` : ''}
                            </div>
                            <div style="background: var(--bg-surface); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--radius-lg);">
                                <h3 style="color: var(--text-main); margin-bottom: 1rem;">Device Information</h3>
                                <p><strong>Type:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.deviceType)}</span></p>
                                <p><strong>Brand:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.brand)}</span></p>
                                <p><strong>Model:</strong> ${escapeHTML(repair.model)}</p>
                                ${repair.serialNumber ? `<p><strong>Serial:</strong> ${escapeHTML(repair.serialNumber)}</p>` : ''}
                                <p><strong>Condition:</strong> ${escapeHTML(repair.deviceCondition) || 'Not specified'}</p>
                            </div>
                        </div>
                        <div style="background: var(--bg-surface); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                            <h3 style="color: var(--text-main); margin-bottom: 1rem;">Repair Details</h3>
                            <p><strong>Issue:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.issueDescription)}</span></p>
                            <p><strong>Current Status:</strong> <span class="status-badge ${statusConfig[repair.currentStatus]?.class || 'status-received'}">${statusConfig[repair.currentStatus]?.label || 'Received'}</span></p>
                            <p><strong>Date Received:</strong> <span style="color: var(--text-muted);">${repair.dateReceived ? new Date(repair.dateReceived.seconds * 1000).toLocaleString('en-GB') : 'N/A'}</span></p>
                            ${repair.estimatedCompletion ? `<p><strong>Est. Completion:</strong> <span style="color: var(--text-muted);">${new Date(repair.estimatedCompletion.seconds * 1000).toLocaleDateString('en-GB')}</span></p>` : ''}
                            ${repair.estimatedCost ? `<p><strong>Est. Cost:</strong> <span style="color: var(--text-muted);">£${escapeHTML(repair.estimatedCost)}</span></p>` : ''}
                            ${repair.additionalNotes ? `<p><strong>Notes:</strong> <span style="color: var(--text-muted);">${escapeHTML(repair.additionalNotes)}</span></p>` : ''}
                        </div>
                        ${repair.progress && repair.progress.length > 0 ? `
                            <div style="background: var(--bg-surface); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                                <h3 style="color: var(--text-main); margin-bottom: 1rem;">Progress History</h3>
                                ${repair.progress.map(p => `
                                    <div style="padding: 1rem; background: var(--bg-base); border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <strong style="color: var(--text-main);">${statusConfig[p.status]?.label || p.status}</strong>
                                            <small style="color: var(--text-muted);">${p.timestamp ? new Date(p.timestamp.seconds * 1000).toLocaleString('en-GB') : 'N/A'}</small>
                                        </div>
                                        ${p.notes ? `<p style="color: var(--text-muted); margin: 0;">${escapeHTML(p.notes)}</p>` : ''}
                                        ${p.technician ? `<p style="color: var(--text-dark); font-size: 0.9rem; margin: 0.5rem 0 0 0;">By: ${escapeHTML(p.technician)}</p>` : ''}
                                        ${p.photos && p.photos.length > 0 ? `
                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                                                ${p.photos.map(photo => `
                                                    <img src="${photo}" alt="Progress photo" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid var(--border-color);" data-action="open-photo" data-url="${photo}">
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div style="background: var(--bg-surface); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: var(--radius-lg); margin-bottom: 2rem;">
                        <h3 style="color: var(--text-main); margin-bottom: 1rem;"><i class="fas fa-comment-dots" style="margin-right: 0.5rem;"></i>Contact Customer</h3>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem;">Send a status update to ${escapeHTML(repair.customerName.split(' ')[0])} — message is pre-filled based on the current repair status.</p>
                        <div class="comms-actions">
                            <button class="btn comms-btn comms-whatsapp" data-action="whatsapp" data-id="${repairId}">
                                <i class="fab fa-whatsapp"></i>
                                WhatsApp
                            </button>
                            <button class="btn comms-btn comms-sms" data-action="sms" data-id="${repairId}">
                                <i class="fas fa-sms"></i>
                                SMS
                            </button>
                            <button class="btn comms-btn comms-copy" data-action="copy-link" data-id="${repairId}">
                                <i class="fas fa-link"></i>
                                Copy Tracking Link
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <button class="btn btn-primary" data-action="edit-close" data-id="${repairId}">
                            <i class="fas fa-edit"></i>
                            Edit Repair
                        </button>
                        <button class="btn btn-secondary" data-action="close-modal">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Edit repair - show status update modal
        function editRepair(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;

            // Reset update photos
            updatePhotos = [];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Update Repair - ${escapeHTML(repair.repairId)}</h2>
                        <button class="close-btn" data-action="close-modal">&times;</button>
                    </div>
                    <form id="update-repair-form" data-repair-id="${repairId}">
                        <div class="form-group" style="background: var(--bg-surface); border: 1px solid var(--border-color); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 1.5rem;">
                            <label class="form-label">Customer: <span style="color: var(--text-main); font-weight: 400;">${escapeHTML(repair.customerName)}</span></label>
                            <label class="form-label" style="margin-bottom: 0;">Device: <span style="color: var(--text-main); font-weight: 400;">${escapeHTML(repair.brand)} ${escapeHTML(repair.model)}</span></label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Update Status</label>
                            <select class="form-input" name="newStatus" id="status-select" onchange="showTemplates(this.value)">
                                <option value="received" ${repair.currentStatus === 'received' ? 'selected' : ''}>Received</option>
                                <option value="diagnosing" ${repair.currentStatus === 'diagnosing' ? 'selected' : ''}>Diagnosing</option>
                                <option value="waiting-parts" ${repair.currentStatus === 'waiting-parts' ? 'selected' : ''}>Waiting for Parts</option>
                                <option value="in-repair" ${repair.currentStatus === 'in-repair' ? 'selected' : ''}>In Repair</option>
                                <option value="testing" ${repair.currentStatus === 'testing' ? 'selected' : ''}>Testing</option>
                                <option value="ready" ${repair.currentStatus === 'ready' ? 'selected' : ''}>Ready for Collection</option>
                                <option value="completed" ${repair.currentStatus === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                        <div class="template-selector" id="template-selector" style="display: none;">
                            <label class="form-label">Quick Templates:</label>
                            <div id="template-buttons"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progress Notes</label>
                            <textarea class="form-input form-textarea" name="progressNotes" id="progress-notes" placeholder="Add notes about this status update..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Add Photos (Optional)</label>
                            <div class="photo-upload-small" data-action="upload-photo">
                                <i class="fas fa-camera" style="font-size: 1.5rem; color: var(--gray-400); margin-bottom: 0.5rem; display: block;"></i>
                                <span style="color: var(--gray-600); font-size: 0.9rem;">Click to add photos</span>
                                <input type="file" id="update-photo-input" multiple accept="image/*" style="display: none;" onchange="handleUpdatePhotos(event)">
                            </div>
                            <div class="photo-preview-small" id="update-photo-preview"></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Estimated Completion Date</label>
                                <input type="date" class="form-input" name="estimatedCompletion" 
                                    value="${repair.estimatedCompletion ? new Date(repair.estimatedCompletion.seconds * 1000).toISOString().split('T')[0] : ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estimated Cost (£)</label>
                                <input type="number" class="form-input" name="estimatedCost" step="0.01" 
                                    value="${repair.estimatedCost || ''}">
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <button type="button" class="btn btn-secondary" data-action="close-modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Update Repair
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Show templates for current status
            showTemplates(repair.currentStatus);

            // Handle form submission
            document.getElementById('update-repair-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const repairId = e.target.dataset.repairId;
                await updateRepairStatus(repairId, e.target);
                modal.remove();
            });
        }

        // Update repair status
        async function updateRepairStatus(repairId, form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const updateData = {
                    currentStatus: data.newStatus,
                };

                // Add optional fields if provided
                if (data.estimatedCompletion) {
                    updateData.estimatedCompletion = firebase.firestore.Timestamp.fromDate(new Date(data.estimatedCompletion));
                }
                if (data.estimatedCost) {
                    updateData.estimatedCost = parseFloat(data.estimatedCost);
                }

                // Upload photos if any
                const photoUrls = [];
                if (updatePhotos.length > 0) {
                    const repair = allRepairs.find(r => r.id === repairId);
                    for (const photo of updatePhotos) {
                        try {
                            const photoRef = storage.ref().child(`repairs/${repair.repairId}/updates/${Date.now()}_${photo.id}`);
                            const snapshot = await photoRef.put(photo.file);
                            const downloadURL = await snapshot.ref.getDownloadURL();
                            photoUrls.push(downloadURL);
                        } catch (error) {
                            // Photo upload failed, continue with remaining
                        }
                    }

                    // Add new photos to existing photos array
                    updateData.photos = firebase.firestore.FieldValue.arrayUnion(...photoUrls);
                }

                // Add progress entry
                const progressEntry = {
                    status: data.newStatus,
                    timestamp: firebase.firestore.Timestamp.now(),
                    notes: data.progressNotes || `Status updated to ${statusConfig[data.newStatus]?.label || data.newStatus}`,
                    technician: currentUser.email,
                    photos: photoUrls
                };

                updateData.progress = firebase.firestore.FieldValue.arrayUnion(progressEntry);

                // Update in Firestore
                await db.collection('repairs').doc(repairId).update(updateData);

                showAlert('Repair updated successfully!', 'success');

                // Reload data
                loadDashboardData();

                // Reset update photos
                updatePhotos = [];

            } catch (error) {
                showAlert('Error updating repair: ' + error.message, 'error');
            }
        }

        // Load all repairs with optional filter
        function loadAllRepairs() {
            const statusFilter = document.getElementById('status-filter').value;
            const commonFilter = document.getElementById('common-repair-filter').value;

            let filteredRepairs = allRepairs;

            // Apply Status Filter
            if (statusFilter) {
                filteredRepairs = filteredRepairs.filter(r => r.currentStatus === statusFilter);
            }

            // Apply Common Repair Filter
            if (commonFilter) {
                filteredRepairs = filteredRepairs.filter(r => {
                    // Combine relevant fields for text search
                    const text = `${r.deviceType || ''} ${r.brand || ''} ${r.model || ''} ${r.issueDescription || ''}`.toLowerCase();

                    if (commonFilter === 'hdmi') {
                        return text.includes('hdmi');
                    }
                    if (commonFilter === 'cleaning') {
                        return text.includes('clean') || text.includes('dust');
                    }
                    if (commonFilter === 'pc-rebuild') {
                        return text.includes('rebuild') || text.includes('build') || text.includes('assembly');
                    }
                    if (commonFilter === 'laptop-diag') {
                        return (text.includes('laptop') || text.includes('macbook')) &&
                            (text.includes('diag') || text.includes('check') || text.includes('inspect'));
                    }
                    return true;
                });
            }

            const tbody = document.querySelector('#all-repairs-table tbody');
            tbody.innerHTML = '';

            filteredRepairs.forEach(repair => {
                const row = createDetailedRepairRow(repair);
                tbody.appendChild(row);
            });
        }

        function createDetailedRepairRow(repair) {
            const row = document.createElement('tr');
            const status = statusConfig[repair.currentStatus] || statusConfig['received'];
            const dateReceived = repair.dateReceived ? new Date(repair.dateReceived.seconds * 1000).toLocaleDateString('en-GB') : 'N/A';
            const estCompletion = repair.estimatedCompletion ? new Date(repair.estimatedCompletion.seconds * 1000).toLocaleDateString('en-GB') : 'TBD';

            row.innerHTML = `
                <td data-label="Repair ID"><strong>${escapeHTML(repair.repairId)}</strong></td>
                <td data-label="Customer">${escapeHTML(repair.customerName)}<br><small>${escapeHTML(repair.customerPhone)}</small></td>
                <td data-label="Device">${escapeHTML(repair.deviceType)}<br><small>${escapeHTML(repair.brand)} ${escapeHTML(repair.model)}</small></td>
                <td data-label="Issue" title="${escapeHTML(repair.issueDescription)}">${escapeHTML(repair.issueDescription).substring(0, 50)}${repair.issueDescription.length > 50 ? '...' : ''}</td>
                <td data-label="Status"><span class="status-badge ${status.class}">${status.label}</span></td>
                <td data-label="Received">${dateReceived}</td>
                <td data-label="Est. Completion">${estCompletion}</td>
                <td data-label="">
                    <button class="btn btn-secondary" style="padding: 0.5rem;" data-action="view" data-id="${repair.id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-primary" style="padding: 0.5rem;" data-action="edit" data-id="${repair.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem;" data-action="delete" data-id="${repair.id}" data-repair-id="${repair.repairId}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            document.querySelector('.main-content').insertBefore(alert, document.querySelector('.header').nextSibling);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Show templates for selected status
        function showTemplates(status) {
            const templates = statusTemplates[status];
            const selector = document.getElementById('template-selector');
            const buttonsContainer = document.getElementById('template-buttons');

            if (templates && templates.length > 0) {
                selector.style.display = 'block';
                buttonsContainer.innerHTML = '';

                templates.forEach((template, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'template-btn';
                    btn.textContent = `Template ${index + 1}`;
                    btn.onclick = () => {
                        document.getElementById('progress-notes').value = template;
                    };
                    buttonsContainer.appendChild(btn);
                });
            } else {
                selector.style.display = 'none';
            }
        }

        // Handle photo upload for updates
        function handleUpdatePhotos(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        addUpdatePhotoPreview(e.target.result, file);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addUpdatePhotoPreview(src, file) {
            const preview = document.getElementById('update-photo-preview');
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item-small';

            const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            photoItem.innerHTML = `
                <img src="${escapeHTML(src)}" alt="Update photo">
                <button type="button" class="photo-remove-small" data-action="remove-photo" data-id="${escapeHTML(photoId)}">×</button>
            `;

            photoItem.dataset.photoId = photoId;
            preview.appendChild(photoItem);

            updatePhotos.push({ id: photoId, file, src });
        }

        function removeUpdatePhoto(photoId) {
            const photoElement = document.querySelector(`[data-photo-id="${photoId}"]`);
            if (photoElement) {
                photoElement.remove();
            }
            updatePhotos = updatePhotos.filter(photo => photo.id !== photoId);
        }

        // Delete repair
        async function deleteRepair(repairId, repairIdNumber) {
            if (confirm(`Are you sure you want to delete repair ${repairIdNumber}? This action cannot be undone.`)) {
                try {
                    // Delete from Firestore
                    await db.collection('repairs').doc(repairId).delete();

                    // Delete photos from Storage if any
                    const repair = allRepairs.find(r => r.id === repairId);
                    if (repair && repair.photos && repair.photos.length > 0) {
                        // Note: You might want to delete photos from storage here
                        // This requires parsing the photo URLs to get the storage paths
                    }

                    showAlert(`Repair ${repairIdNumber} deleted successfully!`, 'success');

                    // Reload data
                    loadDashboardData();

                } catch (error) {
                    showAlert('Error deleting repair: ' + error.message, 'error');
                }
            }
        }
        // Event listeners for static elements (replacing inline onclick)
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            if (sidebarOverlay) sidebarOverlay.addEventListener('click', toggleSidebar);

            const menuToggle = document.getElementById('menu-toggle');
            if (menuToggle) menuToggle.addEventListener('click', toggleSidebar);

            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) logoutLink.addEventListener('click', function(e) { e.preventDefault(); logout(); });

            const viewAllBtn = document.getElementById('view-all-repairs-btn');
            if (viewAllBtn) viewAllBtn.addEventListener('click', function() { showSection('repairs'); });

            // Event delegation for dynamically generated elements
            document.addEventListener('click', function(e) {
                const btn = e.target.closest('[data-action]');
                if (!btn) return;

                const action = btn.dataset.action;
                const id = btn.dataset.id;
                const repairId = btn.dataset.repairId;

                switch(action) {
                    case 'view': viewRepair(id); break;
                    case 'edit': editRepair(id); break;
                    case 'delete': deleteRepair(id, repairId); break;
                    case 'close-modal': btn.closest('.modal').remove(); break;
                    case 'edit-close': editRepair(id); btn.closest('.modal').remove(); break;
                    case 'whatsapp': sendWhatsApp(id); break;
                    case 'sms': sendSMS(id); break;
                    case 'copy-link': copyTrackingLink(id); break;
                    case 'open-photo': window.open(btn.dataset.url, '_blank'); break;
                    case 'upload-photo': document.getElementById('update-photo-input').click(); break;
                    case 'remove-photo': removeUpdatePhoto(id); break;
                }
            });
        });
    </script>
</body>

</html>