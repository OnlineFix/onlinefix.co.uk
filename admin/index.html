<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - OnlineFix Repair Management</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" integrity="sha512-fD9DI5bZwQxOi7MhYWnnNPlvXdp/2Pj3XSTRrFs5FQa4mizyGLnJcN6tuvUS6LbmgN1ut+XGSABKvjN0H6Aoow==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066FF;
            --trust-teal: #00B4D8;
            --deep-blue: #023E8A;
            --accent-cyan: #90E0EF;
            --light-bg: #F8FAFC;
            --white: #FFFFFF;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-600: #64748B;
            --gray-800: #1E293B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: var(--light-bg);
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--white);
            border-right: 1px solid var(--gray-200);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }

        .user-info {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .sidebar-nav {
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--gray-600);
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--primary-blue);
            color: var(--white);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        /* Header */
        .header {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--deep-blue);
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--deep-blue);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-800);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin: 0 auto 1rem;
            color: var(--white);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Content Sections */
        .content-section {
            background: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .section-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--deep-blue);
        }

        .section-content {
            padding: 2rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        th {
            background: var(--gray-100);
            font-weight: 600;
            color: var(--gray-800);
        }

        tr:hover {
            background: var(--gray-100);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-received { background: #EEF2FF; color: #3730A3; }
        .status-diagnosing { background: #FEF3C7; color: #92400E; }
        .status-waiting-parts { background: #FEE2E2; color: #B91C1C; }
        .status-in-repair { background: #DBEAFE; color: #1D4ED8; }
        .status-testing { background: #E0E7FF; color: #5B21B6; }
        .status-ready { background: #D1FAE5; color: #065F46; }
        .status-completed { background: #F3F4F6; color: #374151; }

        /* Delete button */
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        /* Photo upload in modal */
        .photo-upload-small {
            border: 2px dashed var(--gray-200);
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .photo-upload-small:hover {
            border-color: var(--primary-blue);
            background: rgba(0, 102, 255, 0.02);
        }

        .photo-preview-small {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .photo-item-small {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item-small img {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }

        .photo-remove-small {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--danger);
            color: var(--white);
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 0.7rem;
        }

        /* Template selector */
        .template-selector {
            margin-bottom: 1rem;
        }

        .template-btn {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-btn:hover {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            background: var(--white);
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: 15px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--deep-blue);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-600);
        }

        /* Loading States */
        .loading {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top: 3px solid var(--primary-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide elements initially */
        .hidden {
            display: none !important;
        }

        /* Success/Error messages */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-success {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }

        .alert-error {
            background: #FEE2E2;
            color: #B91C1C;
            border: 1px solid #FCA5A5;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .main-content {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--deep-blue), var(--primary-blue));">
            <div style="background: var(--white); padding: 3rem; border-radius: 20px; box-shadow: var(--shadow); max-width: 400px; width: 90%;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div class="logo" style="font-size: 2rem; margin-bottom: 0.5rem;">OnlineFix</div>
                    <p style="color: var(--gray-600);">Admin Dashboard Login</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i>
                        Login
                    </button>
                </form>
                <div id="login-error" class="alert alert-error hidden" style="margin-top: 1rem;"></div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="admin-layout hidden">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">OnlineFix</div>
                <div class="user-info" id="user-email">Admin Dashboard</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="#" class="nav-link active" data-section="overview">
                        <i class="fas fa-chart-line"></i>
                        Overview
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" data-section="repairs">
                        <i class="fas fa-tools"></i>
                        All Repairs
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 class="header-title" id="page-title">Dashboard Overview</h1>
                <div class="header-actions">
                    <a href="../new-repair/" class="btn btn-primary">
                        <i class="fas fa-plus"></i>
                        New Repair
                    </a>
                </div>
            </div>

            <!-- Overview Section -->
            <div id="overview-section" class="content-section">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--primary-blue);">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div class="stat-number" id="total-repairs">0</div>
                        <div class="stat-label">Total Repairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--warning);">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-number" id="active-repairs">0</div>
                        <div class="stat-label">Active Repairs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--success);">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-number" id="ready-repairs">0</div>
                        <div class="stat-label">Ready for Collection</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--trust-teal);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-number" id="total-customers">0</div>
                        <div class="stat-label">Total Customers</div>
                    </div>
                </div>

                <!-- Recent Repairs -->
                <div class="content-section">
                    <div class="section-header">
                        <h2 class="section-title">Recent Repairs</h2>
                        <button class="btn btn-secondary" onclick="showSection('repairs')">View All</button>
                    </div>
                    <div class="section-content">
                        <div class="table-container">
                            <table id="recent-repairs-table">
                                <thead>
                                    <tr>
                                        <th>Repair ID</th>
                                        <th>Customer</th>
                                        <th>Device</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Repairs Section -->
            <div id="repairs-section" class="content-section hidden">
                <div class="section-header">
                    <h2 class="section-title">All Repairs</h2>
                    <div>
                        <select id="status-filter" class="form-input" style="display: inline-block; width: auto; margin-right: 1rem;">
                            <option value="">All Statuses</option>
                            <option value="received">Received</option>
                            <option value="diagnosing">Diagnosing</option>
                            <option value="waiting-parts">Waiting for Parts</option>
                            <option value="in-repair">In Repair</option>
                            <option value="testing">Testing</option>
                            <option value="ready">Ready</option>
                            <option value="completed">Completed</option>
                        </select>
                        <a href="../new-repair/" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            New Repair
                        </a>
                    </div>
                </div>
                <div class="section-content">
                    <div class="table-container">
                        <table id="all-repairs-table">
                            <thead>
                                <tr>
                                    <th>Repair ID</th>
                                    <th>Customer</th>
                                    <th>Device</th>
                                    <th>Issue</th>
                                    <th>Status</th>
                                    <th>Date Received</th>
                                    <th>Est. Completion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading dashboard data...</p>
            </div>
        </main>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAuPjwwwkqau6Wzfx7rURAe9jYPpgNbil4",
            authDomain: "onlinefix-repair.firebaseapp.com",
            projectId: "onlinefix-repair",
            storageBucket: "onlinefix-repair.firebasestorage.app",
            messagingSenderId: "382934797751",
            appId: "1:382934797751:web:5ac8a9c87d68a17b4cec32"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let allRepairs = [];
        let updatePhotos = [];

        // Status configuration
        const statusConfig = {
            'received': { label: 'Received', class: 'status-received' },
            'diagnosing': { label: 'Diagnosing', class: 'status-diagnosing' },
            'waiting-parts': { label: 'Waiting for Parts', class: 'status-waiting-parts' },
            'in-repair': { label: 'In Repair', class: 'status-in-repair' },
            'testing': { label: 'Testing', class: 'status-testing' },
            'ready': { label: 'Ready for Collection', class: 'status-ready' },
            'completed': { label: 'Completed', class: 'status-completed' }
        };

        // Status update templates
        const statusTemplates = {
            'diagnosing': [
                'Initial diagnosis in progress. We are examining your device to identify all issues.',
                'Running diagnostic tests to determine the exact cause of the problem.',
                'Device diagnosis complete. We have identified the issues and will proceed with repairs.'
            ],
            'waiting-parts': [
                'We need to order replacement parts for your device. Expected arrival within 2-3 business days.',
                'Waiting for specific components to arrive. We\'ll update you once parts are received.',
                'Additional parts required for complete repair. Order has been placed with our supplier.'
            ],
            'in-repair': [
                'Repair work has begun on your device. Our technician is working on fixing the identified issues.',
                'Your device is currently being repaired. We expect to complete the work within 24-48 hours.',
                'Repair in progress. Additional issues were discovered that require attention.'
            ],
            'testing': [
                'Repair completed. Now conducting thorough testing to ensure everything works perfectly.',
                'Running quality checks and stress tests on your repaired device.',
                'Final testing phase. Verifying all functions are working as expected.'
            ],
            'ready': [
                'Great news! Your device is repaired and ready for collection. Please bring your receipt.',
                'Repair completed successfully. Your device is ready to be picked up at your convenience.',
                'Your device has been fully repaired and tested. Ready for collection during business hours.'
            ],
            'completed': [
                'Repair completed and device collected. Thank you for choosing OnlineFix!',
                'Service completed. We hope you\'re satisfied with our repair service.',
                'Device successfully repaired and delivered to customer.'
            ]
        };

        // Authentication state observer
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                showDashboard();
                loadDashboardData();
            } else {
                showLogin();
            }
        });

        // Login form submission
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showLoginError(error.message);
            }
        });

        // Navigation
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.closest('.nav-link').dataset.section;
                if (section) {
                    showSection(section);
                }
            });
        });

        // Status filter
        document.getElementById('status-filter').addEventListener('change', (e) => {
            loadAllRepairs(e.target.value);
        });

        // Show/hide screens
        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // Logout
        function logout() {
            auth.signOut();
        }

        // Navigation
        function showSection(sectionName) {
            // Update active nav link
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionName) {
                    link.classList.add('active');
                }
            });

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            const section = document.getElementById(`${sectionName}-section`);
            if (section) {
                section.classList.remove('hidden');
            }

            // Update page title
            const titles = {
                'overview': 'Dashboard Overview',
                'repairs': 'All Repairs'
            };
            document.getElementById('page-title').textContent = titles[sectionName] || 'Dashboard';

            // Load section-specific data
            if (sectionName === 'repairs') {
                loadAllRepairs();
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                // Load repairs
                const repairsSnapshot = await db.collection('repairs').get();
                allRepairs = repairsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Update stats
                updateStats();

                // Load recent repairs
                loadRecentRepairs();

                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').style.display = 'none';
                showAlert('Error loading data: ' + error.message, 'error');
            }
        }

        // Update stats
        function updateStats() {
            const activeRepairs = allRepairs.filter(r => 
                !['completed'].includes(r.currentStatus)
            ).length;

            const readyRepairs = allRepairs.filter(r => 
                r.currentStatus === 'ready'
            ).length;

            const customers = new Set(allRepairs.map(r => r.customerEmail || r.customerPhone)).size;

            document.getElementById('total-repairs').textContent = allRepairs.length;
            document.getElementById('active-repairs').textContent = activeRepairs;
            document.getElementById('ready-repairs').textContent = readyRepairs;
            document.getElementById('total-customers').textContent = customers;
        }

        // Load recent repairs
        function loadRecentRepairs() {
            const recent = allRepairs
                .sort((a, b) => {
                    const aTime = a.dateReceived?.seconds || 0;
                    const bTime = b.dateReceived?.seconds || 0;
                    return bTime - aTime;
                })
                .slice(0, 10);

            const tbody = document.querySelector('#recent-repairs-table tbody');
            tbody.innerHTML = '';

            recent.forEach(repair => {
                const row = createRepairRow(repair);
                tbody.appendChild(row);
            });
        }

        // Create repair table row
        function createRepairRow(repair) {
            const row = document.createElement('tr');
            const status = statusConfig[repair.currentStatus] || statusConfig['received'];
            const date = repair.dateReceived ? new Date(repair.dateReceived.seconds * 1000).toLocaleDateString('en-GB') : 'N/A';
            
            row.innerHTML = `
                <td><strong>${repair.repairId}</strong></td>
                <td>${repair.customerName}</td>
                <td>${repair.brand} ${repair.model}</td>
                <td><span class="status-badge ${status.class}">${status.label}</span></td>
                <td>${date}</td>
                <td>
                    <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="viewRepair('${repair.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-primary" style="padding: 0.5rem;" onclick="editRepair('${repair.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem;" onclick="deleteRepair('${repair.id}', '${repair.repairId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // View repair details
        function viewRepair(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Repair Details - ${repair.repairId}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="max-height: 70vh; overflow-y: auto;">
                        <div class="form-grid" style="margin-bottom: 2rem;">
                            <div style="background: var(--gray-100); padding: 1.5rem; border-radius: 15px;">
                                <h3 style="color: var(--deep-blue); margin-bottom: 1rem;">Customer Information</h3>
                                <p><strong>Name:</strong> ${repair.customerName}</p>
                                <p><strong>Phone:</strong> ${repair.customerPhone}</p>
                                ${repair.customerEmail ? `<p><strong>Email:</strong> ${repair.customerEmail}</p>` : ''}
                                ${repair.customerAddress ? `<p><strong>Address:</strong> ${repair.customerAddress}</p>` : ''}
                            </div>
                            <div style="background: var(--gray-100); padding: 1.5rem; border-radius: 15px;">
                                <h3 style="color: var(--deep-blue); margin-bottom: 1rem;">Device Information</h3>
                                <p><strong>Type:</strong> ${repair.deviceType}</p>
                                <p><strong>Brand:</strong> ${repair.brand}</p>
                                <p><strong>Model:</strong> ${repair.model}</p>
                                ${repair.serialNumber ? `<p><strong>Serial:</strong> ${repair.serialNumber}</p>` : ''}
                                <p><strong>Condition:</strong> ${repair.deviceCondition || 'Not specified'}</p>
                            </div>
                        </div>
                        <div style="background: var(--gray-100); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                            <h3 style="color: var(--deep-blue); margin-bottom: 1rem;">Repair Details</h3>
                            <p><strong>Issue:</strong> ${repair.issueDescription}</p>
                            <p><strong>Current Status:</strong> <span class="status-badge ${statusConfig[repair.currentStatus]?.class || 'status-received'}">${statusConfig[repair.currentStatus]?.label || 'Received'}</span></p>
                            <p><strong>Date Received:</strong> ${repair.dateReceived ? new Date(repair.dateReceived.seconds * 1000).toLocaleString('en-GB') : 'N/A'}</p>
                            ${repair.estimatedCompletion ? `<p><strong>Est. Completion:</strong> ${new Date(repair.estimatedCompletion.seconds * 1000).toLocaleDateString('en-GB')}</p>` : ''}
                            ${repair.estimatedCost ? `<p><strong>Est. Cost:</strong> £${repair.estimatedCost}</p>` : ''}
                            ${repair.additionalNotes ? `<p><strong>Notes:</strong> ${repair.additionalNotes}</p>` : ''}
                        </div>
                        ${repair.progress && repair.progress.length > 0 ? `
                            <div style="background: var(--gray-100); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem;">
                                <h3 style="color: var(--deep-blue); margin-bottom: 1rem;">Progress History</h3>
                                ${repair.progress.map(p => `
                                    <div style="padding: 1rem; background: var(--white); border-radius: 10px; margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                            <strong>${statusConfig[p.status]?.label || p.status}</strong>
                                            <small>${p.timestamp ? new Date(p.timestamp.seconds * 1000).toLocaleString('en-GB') : 'N/A'}</small>
                                        </div>
                                        ${p.notes ? `<p style="color: var(--gray-600); margin: 0;">${p.notes}</p>` : ''}
                                        ${p.technician ? `<p style="color: var(--gray-500); font-size: 0.9rem; margin: 0.5rem 0 0 0;">By: ${p.technician}</p>` : ''}
                                        ${p.photos && p.photos.length > 0 ? `
                                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                                                ${p.photos.map(photo => `
                                                    <img src="${photo}" alt="Progress photo" style="width: 100%; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer;" onclick="window.open('${photo}', '_blank')">
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--gray-200);">
                        <button class="btn btn-primary" onclick="editRepair('${repairId}'); this.closest('.modal').remove();">
                            <i class="fas fa-edit"></i>
                            Edit Repair
                        </button>
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Edit repair - show status update modal
        function editRepair(repairId) {
            const repair = allRepairs.find(r => r.id === repairId);
            if (!repair) return;

            // Reset update photos
            updatePhotos = [];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Update Repair - ${repair.repairId}</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <form id="update-repair-form" data-repair-id="${repairId}">
                        <div class="form-group">
                            <label class="form-label">Customer: ${repair.customerName}</label>
                            <label class="form-label">Device: ${repair.brand} ${repair.model}</label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Update Status</label>
                            <select class="form-input" name="newStatus" id="status-select" onchange="showTemplates(this.value)">
                                <option value="received" ${repair.currentStatus === 'received' ? 'selected' : ''}>Received</option>
                                <option value="diagnosing" ${repair.currentStatus === 'diagnosing' ? 'selected' : ''}>Diagnosing</option>
                                <option value="waiting-parts" ${repair.currentStatus === 'waiting-parts' ? 'selected' : ''}>Waiting for Parts</option>
                                <option value="in-repair" ${repair.currentStatus === 'in-repair' ? 'selected' : ''}>In Repair</option>
                                <option value="testing" ${repair.currentStatus === 'testing' ? 'selected' : ''}>Testing</option>
                                <option value="ready" ${repair.currentStatus === 'ready' ? 'selected' : ''}>Ready for Collection</option>
                                <option value="completed" ${repair.currentStatus === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                        <div class="template-selector" id="template-selector" style="display: none;">
                            <label class="form-label">Quick Templates:</label>
                            <div id="template-buttons"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progress Notes</label>
                            <textarea class="form-input form-textarea" name="progressNotes" id="progress-notes" placeholder="Add notes about this status update..."></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Add Photos (Optional)</label>
                            <div class="photo-upload-small" onclick="document.getElementById('update-photo-input').click()">
                                <i class="fas fa-camera" style="font-size: 1.5rem; color: var(--gray-400); margin-bottom: 0.5rem; display: block;"></i>
                                <span style="color: var(--gray-600); font-size: 0.9rem;">Click to add photos</span>
                                <input type="file" id="update-photo-input" multiple accept="image/*" style="display: none;" onchange="handleUpdatePhotos(event)">
                            </div>
                            <div class="photo-preview-small" id="update-photo-preview"></div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Estimated Completion Date</label>
                                <input type="date" class="form-input" name="estimatedCompletion" 
                                    value="${repair.estimatedCompletion ? new Date(repair.estimatedCompletion.seconds * 1000).toISOString().split('T')[0] : ''}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estimated Cost (£)</label>
                                <input type="number" class="form-input" name="estimatedCost" step="0.01" 
                                    value="${repair.estimatedCost || ''}">
                            </div>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                Update Repair
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);

            // Show templates for current status
            showTemplates(repair.currentStatus);

            // Handle form submission
            document.getElementById('update-repair-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const repairId = e.target.dataset.repairId;
                await updateRepairStatus(repairId, e.target);
                modal.remove();
            });
        }

        // Update repair status
        async function updateRepairStatus(repairId, form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            try {
                const updateData = {
                    currentStatus: data.newStatus,
                };

                // Add optional fields if provided
                if (data.estimatedCompletion) {
                    updateData.estimatedCompletion = firebase.firestore.Timestamp.fromDate(new Date(data.estimatedCompletion));
                }
                if (data.estimatedCost) {
                    updateData.estimatedCost = parseFloat(data.estimatedCost);
                }

                // Upload photos if any
                const photoUrls = [];
                if (updatePhotos.length > 0) {
                    const repair = allRepairs.find(r => r.id === repairId);
                    for (const photo of updatePhotos) {
                        try {
                            const photoRef = storage.ref().child(`repairs/${repair.repairId}/updates/${Date.now()}_${photo.id}`);
                            const snapshot = await photoRef.put(photo.file);
                            const downloadURL = await snapshot.ref.getDownloadURL();
                            photoUrls.push(downloadURL);
                        } catch (error) {
                            console.error('Error uploading photo:', error);
                        }
                    }
                    
                    // Add new photos to existing photos array
                    updateData.photos = firebase.firestore.FieldValue.arrayUnion(...photoUrls);
                }

                // Add progress entry
                const progressEntry = {
                    status: data.newStatus,
                    timestamp: firebase.firestore.Timestamp.now(),
                    notes: data.progressNotes || `Status updated to ${statusConfig[data.newStatus]?.label || data.newStatus}`,
                    technician: currentUser.email,
                    photos: photoUrls
                };

                updateData.progress = firebase.firestore.FieldValue.arrayUnion(progressEntry);

                // Update in Firestore
                await db.collection('repairs').doc(repairId).update(updateData);

                showAlert('Repair updated successfully!', 'success');
                
                // Reload data
                loadDashboardData();

                // Reset update photos
                updatePhotos = [];

            } catch (error) {
                console.error('Error updating repair:', error);
                showAlert('Error updating repair: ' + error.message, 'error');
            }
        }

        // Load all repairs with optional filter
        function loadAllRepairs(statusFilter = '') {
            let filteredRepairs = allRepairs;
            
            if (statusFilter) {
                filteredRepairs = allRepairs.filter(r => r.currentStatus === statusFilter);
            }

            const tbody = document.querySelector('#all-repairs-table tbody');
            tbody.innerHTML = '';

            filteredRepairs.forEach(repair => {
                const row = createDetailedRepairRow(repair);
                tbody.appendChild(row);
            });
        }

        function createDetailedRepairRow(repair) {
            const row = document.createElement('tr');
            const status = statusConfig[repair.currentStatus] || statusConfig['received'];
            const dateReceived = repair.dateReceived ? new Date(repair.dateReceived.seconds * 1000).toLocaleDateString('en-GB') : 'N/A';
            const estCompletion = repair.estimatedCompletion ? new Date(repair.estimatedCompletion.seconds * 1000).toLocaleDateString('en-GB') : 'TBD';
            
            row.innerHTML = `
                <td><strong>${repair.repairId}</strong></td>
                <td>${repair.customerName}<br><small>${repair.customerPhone}</small></td>
                <td>${repair.deviceType}<br><small>${repair.brand} ${repair.model}</small></td>
                <td title="${repair.issueDescription}">${repair.issueDescription.substring(0, 50)}${repair.issueDescription.length > 50 ? '...' : ''}</td>
                <td><span class="status-badge ${status.class}">${status.label}</span></td>
                <td>${dateReceived}</td>
                <td>${estCompletion}</td>
                <td>
                    <button class="btn btn-secondary" style="padding: 0.5rem;" onclick="viewRepair('${repair.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-primary" style="padding: 0.5rem;" onclick="editRepair('${repair.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-danger" style="padding: 0.5rem;" onclick="deleteRepair('${repair.id}', '${repair.repairId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            return row;
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            document.querySelector('.main-content').insertBefore(alert, document.querySelector('.header').nextSibling);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Close modals when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // Show templates for selected status
        function showTemplates(status) {
            const templates = statusTemplates[status];
            const selector = document.getElementById('template-selector');
            const buttonsContainer = document.getElementById('template-buttons');
            
            if (templates && templates.length > 0) {
                selector.style.display = 'block';
                buttonsContainer.innerHTML = '';
                
                templates.forEach((template, index) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'template-btn';
                    btn.textContent = `Template ${index + 1}`;
                    btn.onclick = () => {
                        document.getElementById('progress-notes').value = template;
                    };
                    buttonsContainer.appendChild(btn);
                });
            } else {
                selector.style.display = 'none';
            }
        }

        // Handle photo upload for updates
        function handleUpdatePhotos(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        addUpdatePhotoPreview(e.target.result, file);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addUpdatePhotoPreview(src, file) {
            const preview = document.getElementById('update-photo-preview');
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item-small';
            
            const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            photoItem.innerHTML = `
                <img src="${src}" alt="Update photo">
                <button type="button" class="photo-remove-small" onclick="removeUpdatePhoto('${photoId}')">×</button>
            `;
            
            photoItem.dataset.photoId = photoId;
            preview.appendChild(photoItem);
            
            updatePhotos.push({ id: photoId, file, src });
        }

        function removeUpdatePhoto(photoId) {
            const photoElement = document.querySelector(`[data-photo-id="${photoId}"]`);
            if (photoElement) {
                photoElement.remove();
            }
            updatePhotos = updatePhotos.filter(photo => photo.id !== photoId);
        }

        // Delete repair
        async function deleteRepair(repairId, repairIdNumber) {
            if (confirm(`Are you sure you want to delete repair ${repairIdNumber}? This action cannot be undone.`)) {
                try {
                    // Delete from Firestore
                    await db.collection('repairs').doc(repairId).delete();
                    
                    // Delete photos from Storage if any
                    const repair = allRepairs.find(r => r.id === repairId);
                    if (repair && repair.photos && repair.photos.length > 0) {
                        // Note: You might want to delete photos from storage here
                        // This requires parsing the photo URLs to get the storage paths
                    }
                    
                    showAlert(`Repair ${repairIdNumber} deleted successfully!`, 'success');
                    
                    // Reload data
                    loadDashboardData();
                    
                } catch (error) {
                    console.error('Error deleting repair:', error);
                    showAlert('Error deleting repair: ' + error.message, 'error');
                }
            }
        }
    </script>
</body>
</html>
